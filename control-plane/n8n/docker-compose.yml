version: '3.8'

services:
  control-n8n-postgres:
    image: postgres:15-alpine
    container_name: control-n8n-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - control-plane-net

  control-n8n:
    image: n8nio/n8n:latest
    container_name: control-n8n
    restart: unless-stopped
    depends_on:
      control-n8n-postgres:
        condition: service_healthy
    environment:
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=control-n8n-postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=${POSTGRES_DB}
      - DB_POSTGRESDB_USER=${POSTGRES_USER}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}
      - N8N_HOST=${N8N_HOST}
      - N8N_PROTOCOL=${N8N_PROTOCOL}
      - N8N_PORT=${N8N_PORT}
      - WEBHOOK_URL=${WEBHOOK_URL}
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - N8N_BASIC_AUTH_ACTIVE=${N8N_BASIC_AUTH_ACTIVE}
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD}
      - EXECUTIONS_DATA_PRUNE=${EXECUTIONS_DATA_PRUNE}
      - EXECUTIONS_DATA_MAX_AGE=${EXECUTIONS_DATA_MAX_AGE}
      - GENERIC_TIMEZONE=${GENERIC_TIMEZONE}
      - N8N_RUNNERS_ENABLED=true
    volumes:
      - ./data/n8n:/home/node/.n8n
    ports:
      - "5679:5678"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - control-plane-net
      - stack_net

  chronos:
    build:
      context: ../agents/chronos
      dockerfile: Dockerfile
    container_name: chronos
    restart: unless-stopped
    environment:
      - N8N_API_KEY=${N8N_API_KEY}
      - N8N_URL=http://control-n8n:5678
    volumes:
      - ../../shared/backups:/opt/leveredge/shared/backups
    networks:
      - control-plane-net

  hades:
    build:
      context: ../agents/hades
      dockerfile: Dockerfile
    container_name: hades
    restart: unless-stopped
    environment:
      - N8N_API_KEY=${N8N_API_KEY}
      - N8N_URL=http://control-n8n:5678
      - CHRONOS_URL=http://chronos:8010
    volumes:
      - ../../shared/backups:/opt/leveredge/shared/backups
    networks:
      - control-plane-net

  hermes:
    build:
      context: ../agents/hermes
      dockerfile: Dockerfile
    container_name: hermes
    restart: unless-stopped
    environment:
      - EVENT_BUS_URL=http://event-bus:8099
      - TELEGRAM_TOKEN=${TELEGRAM_TOKEN:-}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID:-}
    volumes:
      - ../agents/hermes/data:/app/data
    ports:
      - "8014:8014"
    networks:
      - control-plane-net

  argus:
    build:
      context: ../agents/argus
      dockerfile: Dockerfile
    container_name: argus
    restart: unless-stopped
    environment:
      - EVENT_BUS_URL=http://event-bus:8099
      - PROMETHEUS_URL=http://prometheus:9090
      - HERMES_URL=http://hermes:8014
    ports:
      - "8016:8016"
    networks:
      - control-plane-net
      - stack_net

  aloy:
    build:
      context: ../agents/aloy
      dockerfile: Dockerfile
    container_name: aloy
    restart: unless-stopped
    environment:
      - EVENT_BUS_URL=http://event-bus:8099
      - HERMES_URL=http://hermes:8014
    volumes:
      - ../agents/aloy/data:/app/data
    ports:
      - "8015:8015"
    networks:
      - control-plane-net

  athena:
    build:
      context: ../agents/athena
      dockerfile: Dockerfile
    container_name: athena
    restart: unless-stopped
    environment:
      - EVENT_BUS_URL=http://event-bus:8099
      - DOCS_PATH=/opt/leveredge
    volumes:
      - ../../:/opt/leveredge:ro
    ports:
      - "8013:8013"
    networks:
      - control-plane-net

networks:
  control-plane-net:
    name: control-plane-net
  stack_net:
    external: true
