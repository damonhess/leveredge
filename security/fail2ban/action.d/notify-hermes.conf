# HERMES Notification Action for Fail2ban
# /etc/fail2ban/action.d/notify-hermes.conf
#
# Sends security alerts through the HERMES communication agent
# for unified notification delivery across all channels.

[Definition]

# ============================================================================
# CONFIGURATION
# ============================================================================

# HERMES API endpoint
hermes_url = http://localhost:8100/api/v1/notify

# HERMES API key (loaded from environment)
hermes_key = ${HERMES_API_KEY:-}

# Notification channels (comma-separated)
# Options: slack, email, sms, webhook, telegram, discord
channels = slack,email

# Default severity if not specified
severity = MEDIUM

# ============================================================================
# ACTION COMMANDS
# ============================================================================

# Called once when the jail starts
actionstart =

# Called once when the jail stops
actionstop =

# Called when the jail is reloaded
actionreload =

# Called for each check (ban or unban)
actioncheck =

# ============================================================================
# BAN ACTION
# ============================================================================

actionban = /usr/bin/curl -s -X POST "<hermes_url>" \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer <hermes_key>" \
    -d '{
        "event_type": "security_alert",
        "severity": "<severity>",
        "source": "fail2ban",
        "title": "[FAIL2BAN] Host Banned: <name>",
        "message": "A host has been banned by Fail2ban for suspicious activity.",
        "details": {
            "jail": "<name>",
            "ip": "<ip>",
            "failures": "<failures>",
            "ban_time": "<bantime>",
            "protocol": "<protocol>",
            "port": "<port>",
            "timestamp": "%(now)s",
            "hostname": "%(hostname)s"
        },
        "channels": ["<channels>"],
        "metadata": {
            "action": "ban",
            "geo_lookup": true,
            "threat_intel": true,
            "create_incident": true
        }
    }' \
    || /usr/bin/logger -t fail2ban-hermes "Failed to notify HERMES of ban: <ip> in jail <name>"

# ============================================================================
# UNBAN ACTION
# ============================================================================

actionunban = /usr/bin/curl -s -X POST "<hermes_url>" \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer <hermes_key>" \
    -d '{
        "event_type": "security_info",
        "severity": "INFO",
        "source": "fail2ban",
        "title": "[FAIL2BAN] Host Unbanned: <name>",
        "message": "A previously banned host has been released.",
        "details": {
            "jail": "<name>",
            "ip": "<ip>",
            "protocol": "<protocol>",
            "port": "<port>",
            "timestamp": "%(now)s",
            "hostname": "%(hostname)s"
        },
        "channels": ["<channels>"],
        "metadata": {
            "action": "unban",
            "update_incident": true
        }
    }' \
    || /usr/bin/logger -t fail2ban-hermes "Failed to notify HERMES of unban: <ip> in jail <name>"

# ============================================================================
# PARAMETER DEFINITIONS
# ============================================================================

[Init]

# Jail name
name = default

# Protocol (tcp, udp, etc.)
protocol = tcp

# Port number
port = 0

# Severity level (INFO, LOW, MEDIUM, HIGH, CRITICAL)
severity = MEDIUM

# Notification channels
channels = slack,email

# ============================================================================
# ALTERNATE ACTIONS FOR CRITICAL EVENTS
# ============================================================================

# Critical severity action - includes SMS and immediate escalation
[Definition]
actionban_critical = /usr/bin/curl -s -X POST "<hermes_url>" \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer <hermes_key>" \
    -d '{
        "event_type": "security_alert",
        "severity": "CRITICAL",
        "source": "fail2ban",
        "title": "[CRITICAL] Security Threat Detected",
        "message": "IMMEDIATE ATTENTION REQUIRED: A critical security threat has been detected and blocked.",
        "details": {
            "jail": "<name>",
            "ip": "<ip>",
            "failures": "<failures>",
            "ban_time": "<bantime>",
            "protocol": "<protocol>",
            "port": "<port>",
            "timestamp": "%(now)s",
            "hostname": "%(hostname)s"
        },
        "channels": ["slack", "email", "sms", "webhook"],
        "metadata": {
            "action": "ban",
            "geo_lookup": true,
            "threat_intel": true,
            "create_incident": true,
            "escalate": true,
            "pager_duty": true,
            "block_related_ips": true
        }
    }' \
    && /usr/bin/logger -t fail2ban-hermes "CRITICAL: Notified HERMES of critical ban: <ip> in jail <name>"

# ============================================================================
# WEBHOOK FALLBACK
# ============================================================================

# Fallback webhook if HERMES is unavailable
[Definition]
actionban_fallback = /usr/bin/curl -s -X POST "http://localhost:8080/api/v1/security/alert" \
    -H "Content-Type: application/json" \
    -d '{
        "type": "fail2ban_ban",
        "jail": "<name>",
        "ip": "<ip>",
        "severity": "<severity>",
        "timestamp": "%(now)s"
    }' \
    || /usr/bin/logger -t fail2ban "Failed to send fallback alert for <ip>"

# ============================================================================
# HELPER VARIABLES
# ============================================================================

# Current timestamp
now = $(date -u +%%Y-%%m-%%dT%%H:%%M:%%SZ)

# Hostname
hostname = $(hostname -f)

# ============================================================================
# NOTES
# ============================================================================

# To use this action, add to jail configuration:
#
# [sshd]
# action = %(action_)s
#          notify-hermes[name=%(name)s, protocol=%(protocol)s, port=%(port)s, severity=HIGH]
#
# For critical jails:
# action = %(action_)s
#          notify-hermes[name=%(name)s, protocol=%(protocol)s, port=%(port)s, severity=CRITICAL]
#
# Environment variables required:
# - HERMES_API_KEY: Authentication key for HERMES API
#
# The HERMES agent will:
# 1. Enrich the alert with geo-location data
# 2. Check threat intelligence databases
# 3. Create an incident record
# 4. Route notifications based on severity and on-call schedules
# 5. Aggregate related alerts to prevent notification fatigue
