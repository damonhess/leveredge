# LeverEdge Custom Filter for Agent Logs
# /etc/fail2ban/filter.d/leveredge.conf
#
# Detects malicious patterns in LeverEdge platform logs

[INCLUDES]
before = common.conf

[Definition]
# Common prefix for LeverEdge logs
_daemon = leveredge

# ============================================================================
# FAILURE PATTERNS
# ============================================================================

# Authentication failures across all agents
failregex = ^.*\[AUTH\]\s+Failed login attempt from <HOST>.*$
            ^.*\[AUTH\]\s+Invalid API key from <HOST>.*$
            ^.*\[AUTH\]\s+Token validation failed for <HOST>.*$
            ^.*\[AUTH\]\s+Unauthorized access attempt from <HOST>.*$
            ^.*\[SECURITY\]\s+Authentication failed from <HOST>.*$

            # n8n specific patterns
            ^.*n8n.*authentication failed.*<HOST>.*$
            ^.*n8n.*Invalid credentials from <HOST>.*$
            ^.*n8n.*API key rejected from <HOST>.*$

            # Agent-specific patterns
            ^.*CERBERUS.*blocked request from <HOST>.*$
            ^.*AEGIS.*rejected connection from <HOST>.*$
            ^.*HERMES.*auth failure from <HOST>.*$

            # Rate limiting
            ^.*\[RATE_LIMIT\]\s+Exceeded from <HOST>.*$
            ^.*Rate limit exceeded for <HOST>.*$
            ^.*Too many requests from <HOST>.*$

            # Suspicious patterns
            ^.*\[SUSPICIOUS\]\s+Potential attack from <HOST>.*$
            ^.*SQL injection attempt from <HOST>.*$
            ^.*XSS attempt detected from <HOST>.*$
            ^.*Path traversal attempt from <HOST>.*$
            ^.*Command injection attempt from <HOST>.*$

            # Brute force patterns
            ^.*Brute force detected from <HOST>.*$
            ^.*Multiple failed attempts from <HOST>.*$

            # Webhook abuse
            ^.*\[WEBHOOK\]\s+Invalid signature from <HOST>.*$
            ^.*Webhook replay attack from <HOST>.*$

            # Generic error patterns with IP
            ^.*ERROR.*<HOST>.*forbidden.*$
            ^.*ERROR.*<HOST>.*unauthorized.*$
            ^.*ERROR.*<HOST>.*denied.*$

# ============================================================================
# IGNORE PATTERNS
# ============================================================================

ignoreregex = ^.*\[DEBUG\].*$
              ^.*\[INFO\]\s+Health check.*$
              ^.*\[INFO\]\s+Metrics collection.*$
              ^.*\[TEST\].*$

# ============================================================================
# DATE PATTERNS
# ============================================================================

# ISO 8601 format (2024-01-15T10:30:00.000Z)
datepattern = ^%%Y-%%m-%%dT%%H:%%M:%%S
              %%Y-%%m-%%d %%H:%%M:%%S
              {^LN-BEG}

# ============================================================================
# ADDITIONAL DEFINITIONS
# ============================================================================

[Definition]
# Ensure we match the correct host field
_daemon = (?:leveredge|n8n|cerberus|hermes|aegis|agent)

# Custom prefixes for different log formats
prefregex = ^(?:<[^>]+>)?\s*(?:%(__prefix_line)s)?

# Support for JSON logs
# {"timestamp":"...","level":"ERROR","ip":"1.2.3.4","message":"..."}
journalmatch = _SYSTEMD_UNIT=leveredge.service + _SYSTEMD_UNIT=n8n.service


# ============================================================================
# API ABUSE FILTER (separate file can reference this)
# ============================================================================

[leveredge-api-abuse]
# High-frequency API abuse detection
failregex = ^.*<HOST>.*"(GET|POST|PUT|DELETE).*" (429|403).*$
            ^.*<HOST>.*rate.?limit.*$
            ^.*<HOST>.*quota.?exceeded.*$

ignoreregex =

datepattern = ^%%Y-%%m-%%dT%%H:%%M:%%S
              {^LN-BEG}


# ============================================================================
# GATEWAY FILTER
# ============================================================================

[leveredge-gateway]
# API Gateway specific patterns
failregex = ^.*\[GATEWAY\].*<HOST>.*auth.*fail.*$
            ^.*\[GATEWAY\].*<HOST>.*invalid.*token.*$
            ^.*\[GATEWAY\].*<HOST>.*blocked.*$
            ^.*\[GATEWAY\].*<HOST>.*rate.*limit.*$

ignoreregex = ^.*health.*$
              ^.*metrics.*$

datepattern = ^%%Y-%%m-%%dT%%H:%%M:%%S
              {^LN-BEG}


# ============================================================================
# CERBERUS THREAT FILTER
# ============================================================================

[cerberus-threat]
# CERBERUS security agent threat detection
# These are pre-validated threats - immediate action
failregex = ^.*\[THREAT\].*<HOST>.*severity=(HIGH|CRITICAL).*$
            ^.*\[CERBERUS\].*BLOCK.*<HOST>.*$
            ^.*\[CERBERUS\].*ALERT.*<HOST>.*threat_level=(high|critical).*$
            ^.*CERBERUS detected attack from <HOST>.*$

ignoreregex = ^.*severity=(LOW|INFO).*$

datepattern = ^%%Y-%%m-%%dT%%H:%%M:%%S
              {^LN-BEG}


# ============================================================================
# SUPABASE AUTH FILTER
# ============================================================================

[supabase-auth]
# Supabase authentication failures
failregex = ^.*\[supabase\].*auth.*failed.*<HOST>.*$
            ^.*\[supabase\].*invalid.*credentials.*<HOST>.*$
            ^.*\[gotrue\].*authentication.*error.*<HOST>.*$
            ^.*\[postgrest\].*JWT.*invalid.*<HOST>.*$

ignoreregex =

datepattern = ^%%Y-%%m-%%dT%%H:%%M:%%S
              {^LN-BEG}


# ============================================================================
# PORT SCAN FILTER
# ============================================================================

[portscan]
# Detect port scanning activity
failregex = ^.*\[UFW BLOCK\].*SRC=<HOST>.*$
            ^.*iptables.*REJECT.*SRC=<HOST>.*$
            ^.*SYN flood.*<HOST>.*$
            ^.*port scan detected.*<HOST>.*$

ignoreregex =

datepattern = {^LN-BEG}


# ============================================================================
# DOCKER API FILTER
# ============================================================================

[docker-api]
# Docker API abuse detection
failregex = ^.*docker.*unauthorized.*<HOST>.*$
            ^.*docker.*auth.*fail.*<HOST>.*$
            ^.*dockerd.*<HOST>.*denied.*$

ignoreregex =

datepattern = ^%%Y-%%m-%%dT%%H:%%M:%%S
              {^LN-BEG}
