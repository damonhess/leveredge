{
  "name": "22 - Habit Designer",
  "active": true,
  "nodes": [
    {
      "parameters": {},
      "id": "habit-trigger",
      "name": "Execute Workflow Trigger",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "position": [
        100,
        300
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "operation",
              "name": "operation",
              "type": "string",
              "value": "={{ $json.operation || 'design' }}"
            },
            {
              "id": "habit_id",
              "name": "habit_id",
              "type": "string",
              "value": "={{ $json.habit_id || '' }}"
            },
            {
              "id": "desired_habit",
              "name": "desired_habit",
              "type": "string",
              "value": "={{ $json.desired_habit || '' }}"
            },
            {
              "id": "anchor_habit",
              "name": "anchor_habit",
              "type": "string",
              "value": "={{ $json.anchor_habit || '' }}"
            },
            {
              "id": "user_id",
              "name": "user_id",
              "type": "string",
              "value": "={{ $json.user_id || 'damon' }}"
            }
          ]
        },
        "options": {}
      },
      "id": "habit-extract",
      "name": "Extract Input",
      "type": "n8n-nodes-base.set",
      "position": [
        320,
        300
      ],
      "typeVersion": 3.3
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "design",
              "leftValue": "={{ $json.operation }}",
              "rightValue": "design",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "habit-router",
      "name": "Route Operation",
      "type": "n8n-nodes-base.if",
      "position": [
        540,
        300
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "const input = $('Extract Input').first().json;\nconst desiredHabit = input.desired_habit;\nconst anchorHabit = input.anchor_habit;\n\nif (!desiredHabit) {\n  return [{\n    json: {\n      status: 'needs_input',\n      message: 'What habit would you like to build?\\n\\nExamples:\\n- Exercise daily\\n- Read for 30 minutes\\n- Meditate\\n- Write in journal\\n- Practice a skill\\n\\nBe specific about what you want to do regularly.'\n    }\n  }];\n}\n\n// Design the habit using behavioral science principles\nconst habitId = crypto.randomUUID();\n\n// Create tiny version (2-minute rule)\nconst tinyVersions = {\n  'exercise': 'Put on workout clothes and do 2 jumping jacks',\n  'read': 'Read one page',\n  'meditate': 'Take 3 conscious breaths',\n  'write': 'Write one sentence',\n  'practice': 'Practice for 2 minutes',\n  'default': `Do ${desiredHabit} for just 2 minutes`\n};\n\nconst habitLower = desiredHabit.toLowerCase();\nlet tinyVersion = tinyVersions.default;\nfor (const [key, value] of Object.entries(tinyVersions)) {\n  if (habitLower.includes(key)) {\n    tinyVersion = value;\n    break;\n  }\n}\n\n// Design cue-routine-reward loop\nconst habitDesign = {\n  id: habitId,\n  habit_name: desiredHabit,\n  tiny_version: tinyVersion,\n  cue: anchorHabit || 'After I [existing habit], I will...',\n  routine: desiredHabit,\n  reward: 'Immediate: Say \"Yes!\" and do a small celebration\\nLong-term: Track streak and review weekly progress',\n  habit_stack: anchorHabit ? {\n    anchor: anchorHabit,\n    new_habit: desiredHabit,\n    stack_formula: `After ${anchorHabit}, I will ${tinyVersion}`\n  } : null,\n  environment_design: [\n    'Make the cue obvious - put reminders where you\\'ll see them',\n    'Make it attractive - pair with something enjoyable',\n    'Make it easy - reduce friction to start',\n    'Make it satisfying - track and celebrate'\n  ],\n  common_obstacles: [\n    { obstacle: 'Forgetting', solution: 'Set phone reminder, link to anchor habit' },\n    { obstacle: 'No time', solution: 'Start with 2-minute version, schedule specific time' },\n    { obstacle: 'No motivation', solution: 'Make it so small you can\\'t say no' },\n    { obstacle: 'Breaking streak', solution: 'Never miss twice, get back on track immediately' }\n  ],\n  difficulty: 2,\n  save_to_db: true\n};\n\nconst output = `ðŸ”„ HABIT DESIGN COMPLETE\\n\\n` +\n  `ðŸ“Œ HABIT: ${desiredHabit}\\n\\n` +\n  `ðŸ”¬ TINY VERSION (2-Minute Rule):\\n${tinyVersion}\\n\\n` +\n  `ðŸ”— HABIT STACK:` + (anchorHabit ? `\\nAfter ${anchorHabit}, I will ${tinyVersion}` : '\\nChoose an anchor habit (something you already do daily)') + `\\n\\n` +\n  `âš¡ CUE â†’ ROUTINE â†’ REWARD:\\n` +\n  `â€¢ CUE: ${habitDesign.cue}\\n` +\n  `â€¢ ROUTINE: ${desiredHabit}\\n` +\n  `â€¢ REWARD: ${habitDesign.reward}\\n\\n` +\n  `ðŸ  ENVIRONMENT DESIGN:\\n` +\n  habitDesign.environment_design.map((e, i) => `${i+1}. ${e}`).join('\\n') + `\\n\\n` +\n  `âš ï¸ COMMON OBSTACLES & SOLUTIONS:\\n` +\n  habitDesign.common_obstacles.map(o => `â€¢ ${o.obstacle}: ${o.solution}`).join('\\n') + `\\n\\n` +\n  `ðŸŽ¯ START TOMORROW with the tiny version. Don't aim for perfect - aim for consistent.`;\n\nreturn [{\n  json: {\n    status: 'designed',\n    ...habitDesign,\n    formatted_output: output\n  }\n}];"
      },
      "id": "habit-design",
      "name": "Design Habit",
      "type": "n8n-nodes-base.code",
      "position": [
        760,
        180
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT h.*, COALESCE(COUNT(hc.id), 0) as completion_count, MAX(hc.completed_at) as last_completion FROM aria_habits h LEFT JOIN aria_habit_completions hc ON h.id = hc.habit_id WHERE h.user_id = $1 AND h.status = 'building' GROUP BY h.id ORDER BY h.created_at DESC",
        "options": {
          "queryReplacement": "={{ [$json.user_id] }}"
        }
      },
      "id": "habit-list",
      "name": "List Active Habits",
      "type": "n8n-nodes-base.postgres",
      "position": [
        760,
        420
      ],
      "typeVersion": 2.4,
      "credentials": {
        "postgres": {
          "id": "DGroZIqnHY4mrCB7",
          "name": "Supabase Postgres DEV"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const habits = $('List Active Habits').all();\n\nif (habits.length === 0 || !habits[0].json.id) {\n  return [{\n    json: {\n      status: 'no_habits',\n      message: 'No active habits found. Use operation: design to create a new habit.'\n    }\n  }];\n}\n\nlet output = 'ðŸ“Š ACTIVE HABITS\\n\\n';\n\nhabits.forEach((h, i) => {\n  const habit = h.json;\n  const streakEmoji = habit.current_streak >= 7 ? 'ðŸ”¥' : habit.current_streak >= 3 ? 'âœ¨' : 'ðŸ“Œ';\n  output += `${i+1}. ${streakEmoji} ${habit.habit_name}\\n`;\n  output += `   Streak: ${habit.current_streak} days | Best: ${habit.longest_streak} days\\n`;\n  output += `   Tiny version: ${habit.tiny_version || 'Not set'}\\n`;\n  if (habit.last_completion) {\n    const lastDate = new Date(habit.last_completion).toLocaleDateString();\n    output += `   Last completed: ${lastDate}\\n`;\n  }\n  output += '\\n';\n});\n\noutput += '\\nðŸ’¡ Track completion with operation: complete, habit_id: [id]';\n\nreturn [{\n  json: {\n    status: 'list',\n    habits: habits.map(h => h.json),\n    formatted_output: output\n  }\n}];"
      },
      "id": "habit-format-list",
      "name": "Format List",
      "type": "n8n-nodes-base.code",
      "position": [
        980,
        420
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "save",
              "leftValue": "={{ $json.save_to_db }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "habit-check-save",
      "name": "Check if Save",
      "type": "n8n-nodes-base.if",
      "position": [
        1200,
        180
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "mode": "list",
          "value": "aria_habits"
        },
        "columns": {
          "value": {
            "id": "={{ $json.id }}",
            "user_id": "={{ $('Extract Input').first().json.user_id }}",
            "habit_name": "={{ $json.habit_name }}",
            "tiny_version": "={{ $json.tiny_version }}",
            "trigger_cue": "={{ $json.cue }}",
            "routine": "={{ $json.routine }}",
            "reward": "={{ $json.reward }}",
            "habit_stack": "={{ JSON.stringify($json.habit_stack) }}",
            "difficulty": "={{ $json.difficulty }}"
          },
          "schema": [],
          "mappingMode": "defineBelow",
          "matchingColumns": []
        },
        "options": {}
      },
      "id": "habit-save",
      "name": "Save Habit",
      "type": "n8n-nodes-base.postgres",
      "position": [
        1420,
        80
      ],
      "typeVersion": 2.4,
      "credentials": {
        "postgres": {
          "id": "DGroZIqnHY4mrCB7",
          "name": "Supabase Postgres DEV"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT aria_record_tool_usage('habit_designer', true, null)",
        "options": {}
      },
      "id": "habit-record-usage",
      "name": "Record Tool Usage",
      "type": "n8n-nodes-base.postgres",
      "position": [
        1640,
        300
      ],
      "typeVersion": 2.4,
      "credentials": {
        "postgres": {
          "id": "DGroZIqnHY4mrCB7",
          "name": "Supabase Postgres DEV"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "output",
              "name": "output",
              "type": "string",
              "value": "={{ $json.formatted_output || JSON.stringify($json, null, 2) }}"
            }
          ]
        },
        "options": {}
      },
      "id": "habit-output",
      "name": "Format Output",
      "type": "n8n-nodes-base.set",
      "position": [
        1860,
        300
      ],
      "typeVersion": 3.3
    }
  ],
  "connections": {
    "Execute Workflow Trigger": {
      "main": [
        [
          {
            "node": "Extract Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Input": {
      "main": [
        [
          {
            "node": "Route Operation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route Operation": {
      "main": [
        [
          {
            "node": "Design Habit",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "List Active Habits",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Design Habit": {
      "main": [
        [
          {
            "node": "Check if Save",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "List Active Habits": {
      "main": [
        [
          {
            "node": "Format List",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format List": {
      "main": [
        [
          {
            "node": "Record Tool Usage",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check if Save": {
      "main": [
        [
          {
            "node": "Save Habit",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Record Tool Usage",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Habit": {
      "main": [
        [
          {
            "node": "Record Tool Usage",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Record Tool Usage": {
      "main": [
        [
          {
            "node": "Format Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "id": "JGPHsQ7BFDemLOs8"
}
