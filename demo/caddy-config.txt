# ============================================================
# CADDY CONFIGURATION FOR ARIA DEMO ENVIRONMENT
# Add this to your Caddyfile or /etc/caddy/Caddyfile
# ============================================================
#
# This configuration sets up:
# 1. demo.leveredgeai.com - Main demo interface (proxies to ARIA frontend)
# 2. demo.n8n.leveredgeai.com - Demo n8n admin (internal access only)
#
# Prerequisites:
# - DNS A records pointing to your server IP:
#   - demo.leveredgeai.com -> YOUR_SERVER_IP
#   - demo.n8n.leveredgeai.com -> YOUR_SERVER_IP
# - Caddy installed and running
# - Demo n8n container running on port 5681
#
# ============================================================

# ------------------------------------------------------------
# DEMO ARIA INTERFACE
# Main demo endpoint for public demos
# ------------------------------------------------------------

demo.leveredgeai.com {
    # Automatic HTTPS via Let's Encrypt
    tls {
        dns cloudflare {env.CLOUDFLARE_API_TOKEN}
    }

    # Security headers
    header {
        # HSTS
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        # Prevent clickjacking
        X-Frame-Options "SAMEORIGIN"
        # XSS protection
        X-XSS-Protection "1; mode=block"
        # Content type sniffing protection
        X-Content-Type-Options "nosniff"
        # Referrer policy
        Referrer-Policy "strict-origin-when-cross-origin"
        # Demo mode indicator header
        X-Demo-Mode "true"
        # Remove server header
        -Server
    }

    # Rate limiting for demo
    # Requires caddy-ratelimit plugin
    # rate_limit {
    #     zone demo_zone {
    #         key {remote_host}
    #         events 100
    #         window 1h
    #     }
    # }

    # CORS for demo frontend
    @cors_preflight method OPTIONS
    handle @cors_preflight {
        header Access-Control-Allow-Origin "https://demo.leveredgeai.com"
        header Access-Control-Allow-Methods "GET, POST, OPTIONS"
        header Access-Control-Allow-Headers "Content-Type, Authorization"
        header Access-Control-Max-Age "86400"
        respond "" 204
    }

    # Webhook endpoint for ARIA demo
    handle /webhook/* {
        reverse_proxy localhost:5681 {
            header_up Host {upstream_hostport}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Demo-Mode "true"

            # Timeout settings for LLM responses
            transport http {
                response_header_timeout 120s
                read_timeout 120s
                write_timeout 120s
            }
        }
    }

    # Health check endpoint
    handle /health {
        respond "OK - Demo Mode" 200
    }

    # Demo info endpoint
    handle /demo-info {
        respond `{
            "mode": "demo",
            "session_limit_minutes": 15,
            "message_limit": 10,
            "features": ["tasks", "calendar", "memory"],
            "start_trial_url": "https://leveredgeai.com/signup?ref=demo"
        }` 200 {
            header Content-Type "application/json"
        }
    }

    # Static demo landing page (if serving frontend)
    handle {
        # If you have a demo frontend, serve it here
        # root * /opt/leveredge/demo/frontend
        # file_server

        # Otherwise, redirect to main site with demo info
        redir https://leveredgeai.com/demo 302
    }

    # Logging
    log {
        output file /var/log/caddy/demo.leveredgeai.com.log {
            roll_size 10mb
            roll_keep 5
            roll_keep_for 168h
        }
        format json
        level INFO
    }
}

# ------------------------------------------------------------
# DEMO N8N ADMIN INTERFACE
# Internal access only for demo workflow management
# ------------------------------------------------------------

demo.n8n.leveredgeai.com {
    # Automatic HTTPS
    tls {
        dns cloudflare {env.CLOUDFLARE_API_TOKEN}
    }

    # IP allowlist - restrict to internal/VPN only
    @blocked not remote_ip 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16 YOUR_OFFICE_IP/32
    handle @blocked {
        respond "Access Denied - Internal Only" 403
    }

    # Basic auth for additional security (optional)
    # basicauth {
    #     demo $2a$14$YOUR_BCRYPT_HASH_HERE
    # }

    # Security headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        X-Frame-Options "DENY"
        X-Content-Type-Options "nosniff"
        -Server
    }

    # Proxy to demo n8n
    reverse_proxy localhost:5681 {
        header_up Host {upstream_hostport}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}

        # WebSocket support for n8n editor
        transport http {
            response_header_timeout 120s
        }
    }

    # WebSocket handling for n8n
    @websockets {
        header Connection *Upgrade*
        header Upgrade websocket
    }
    handle @websockets {
        reverse_proxy localhost:5681
    }

    # Logging
    log {
        output file /var/log/caddy/demo.n8n.leveredgeai.com.log {
            roll_size 10mb
            roll_keep 5
        }
        format json
        level INFO
    }
}

# ============================================================
# ALTERNATIVE: NGINX CONFIGURATION
# If using nginx instead of Caddy
# ============================================================

# Uncomment and modify if using nginx:

# server {
#     listen 443 ssl http2;
#     server_name demo.leveredgeai.com;
#
#     ssl_certificate /etc/letsencrypt/live/demo.leveredgeai.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/demo.leveredgeai.com/privkey.pem;
#
#     # Security headers
#     add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
#     add_header X-Frame-Options "SAMEORIGIN" always;
#     add_header X-Content-Type-Options "nosniff" always;
#     add_header X-Demo-Mode "true" always;
#
#     # Rate limiting
#     limit_req_zone $binary_remote_addr zone=demo_limit:10m rate=10r/s;
#     limit_req zone=demo_limit burst=20 nodelay;
#
#     location /webhook/ {
#         proxy_pass http://localhost:5681;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_set_header X-Demo-Mode "true";
#
#         # Timeout for LLM responses
#         proxy_read_timeout 120s;
#         proxy_send_timeout 120s;
#     }
#
#     location /health {
#         return 200 "OK - Demo Mode";
#         add_header Content-Type text/plain;
#     }
#
#     location / {
#         return 302 https://leveredgeai.com/demo;
#     }
# }
#
# server {
#     listen 443 ssl http2;
#     server_name demo.n8n.leveredgeai.com;
#
#     ssl_certificate /etc/letsencrypt/live/demo.n8n.leveredgeai.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/demo.n8n.leveredgeai.com/privkey.pem;
#
#     # IP allowlist
#     allow 10.0.0.0/8;
#     allow 172.16.0.0/12;
#     allow 192.168.0.0/16;
#     deny all;
#
#     location / {
#         proxy_pass http://localhost:5681;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#
#         # WebSocket support
#         proxy_http_version 1.1;
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection "upgrade";
#     }
# }

# ============================================================
# DNS CONFIGURATION REMINDER
# ============================================================
#
# Add these DNS records to your domain registrar or Cloudflare:
#
# Type | Name              | Content          | TTL
# -----|-------------------|------------------|-----
# A    | demo              | YOUR_SERVER_IP   | Auto
# A    | demo.n8n          | YOUR_SERVER_IP   | Auto
#
# If using Cloudflare, you can enable proxying (orange cloud)
# for additional DDoS protection on the demo endpoint.
#
# ============================================================
